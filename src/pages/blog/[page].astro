---
import PaginatedBlogLayout from '../../components/blog/PaginatedBlogLayout.astro';
import { getCollection } from 'astro:content';
import { blogSetting, siteConfig } from '../../data/config';

export async function getStaticPaths() {
  const all = await getCollection('blog');
  const filtered = all.filter((post) => import.meta.env.DEV || post.data.publish !== false);

  const getBestDate = (e) => (e.data.publishDate ?? e.data.date);
  const sorted = filtered.sort((a, b) => +new Date(getBestDate(b)) - +new Date(getBestDate(a)));

  const perPage = blogSetting.postsPerPage ?? 6;
  const totalPages = Math.max(1, Math.ceil(sorted.length / perPage));

  console.log("[blog getStaticPaths] posts:", sorted.length, "perPage:", perPage, "totalPages:", totalPages);

  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
    props: { totalPages, perPage },
  }));
}


const { page, totalPages, perPage } = Astro.props as { page: number; totalPages: number; perPage: number };

const all = await getCollection('blog');
const filtered = all.filter((post) => import.meta.env.DEV || post.data.publish !== false);
const getBestDate = (e) => (e.data.publishDate ?? e.data.date);
const sorted = filtered.sort((a, b) => +new Date(getBestDate(b)) - +new Date(getBestDate(a)));

const start = (page - 1) * perPage;
const end = start + perPage;
const paginatedPosts = sorted.slice(start, end);

const base = siteConfig.siteUrl.replace(/\/$/, '');
const isFirst = page === 1;
const isLast = page === totalPages;
const canonical = isFirst ? `${base}/blog/` : `${base}/blog/${page}/`;
const prevUrl = !isFirst ? (page === 2 ? `${base}/blog/` : `${base}/blog/${page - 1}/`) : null;
const nextUrl = !isLast ? `${base}/blog/${page + 1}/` : null;
---

<html lang="en">
  <head>
    <title>Blog â€” Page {page} | {siteConfig.companyName}</title>
    <link rel="canonical" href={canonical} />
    {prevUrl && <link rel="prev" href={prevUrl} />}
    {nextUrl && <link rel="next" href={nextUrl} />}
  </head>
  <body>
    <PaginatedBlogLayout
      posts={paginatedPosts}
      currentPage={page}
      totalPages={totalPages}
      baseUrl="/blog"
      title="Blog"
      subtitle="Latest articles and news from the team"
    />
  </body>
</html>
