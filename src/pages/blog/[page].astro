---
import PaginatedBlogLayout from '../../components/blog/PaginatedBlogLayout.astro';
import { getCollection } from 'astro:content';
import { blogSetting, siteConfig } from '../../data/config';

export const prerender = true;

// Build-time: generate /blog/1, /blog/2, /blog/3, ...
export async function getStaticPaths() {
  const all = await getCollection('blog');

  // Filter unpublished unless dev
  const filtered = all.filter((post) => import.meta.env.DEV || post.data.publish !== false);

  // Sort by date DESC (publishDate only)
  const sorted = filtered.sort((a, b) => {
    const aDate = +(a.data.publishDate ? new Date(a.data.publishDate) : 0);
    const bDate = +(b.data.publishDate ? new Date(b.data.publishDate) : 0);
    return bDate - aDate;
  });

  const perPage = blogSetting.postsPerPage ?? 6;
  const totalPages = Math.max(1, Math.ceil(sorted.length / perPage));

  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
    props: { totalPages, perPage },
  }));
}

const { page, totalPages, perPage } = Astro.props as { page: number; totalPages: number; perPage: number };

// Load again at build for this page’s slice
const all = await getCollection('blog');
const filtered = all.filter((post) => import.meta.env.DEV || post.data.publish !== false);
const sorted = filtered.sort((a, b) => {
  const aDate = +(a.data.publishDate ? new Date(a.data.publishDate) : 0);
  const bDate = +(b.data.publishDate ? new Date(b.data.publishDate) : 0);
  return bDate - aDate;
});

// Slice for current page
const start = (page - 1) * perPage;
const end = start + perPage;
const paginatedPosts = sorted.slice(start, end);

// Canonical / prev / next (for /blog/2 style)
const base = siteConfig.siteUrl.replace(/\/$/, '');
const isFirst = page === 1;
const isLast = page === totalPages;
const canonical = isFirst ? `${base}/blog/` : `${base}/blog/${page}/`;
const prevUrl = !isFirst ? (page === 2 ? `${base}/blog/` : `${base}/blog/${page - 1}/`) : null;
const nextUrl = !isLast ? `${base}/blog/${page + 1}/` : null;
---

<html lang="en">
  <head>
    <title>Blog — Page {page} | {siteConfig.companyName}</title>
    <link rel="canonical" href={canonical} />
    {prevUrl && <link rel="prev" href={prevUrl} />}
    {nextUrl && <link rel="next" href={nextUrl} />}
  </head>
  <body>
    <PaginatedBlogLayout
      posts={paginatedPosts}
      currentPage={page}
      totalPages={totalPages}
      baseUrl="/blog"     {/* your layout can build /blog/2 links from this */}
      title="Blog"
      subtitle="Latest articles and news from the team"
    />
  </body>
</html>
