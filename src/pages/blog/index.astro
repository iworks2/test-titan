---
import { getCollection } from 'astro:content';
import { blogSetting, siteConfig } from '../../data/config';
import PaginatedBlogLayout from '../../components/blog/PaginatedBlogLayout.astro';
export const prerender = true;

const all = await getCollection('blog');
const filtered = all.filter((post) => import.meta.env.DEV || post.data.publish !== false);

const getBestDate = (e) => (e.data.publishDate ?? e.data.date);
const sorted = filtered.sort((a, b) => +new Date(getBestDate(b)) - +new Date(getBestDate(a)));

const perPage = blogSetting.postsPerPage ?? 6;
const totalPages = Math.max(1, Math.ceil(sorted.length / perPage));
const firstPagePosts = sorted.slice(0, perPage);

const base = siteConfig.siteUrl.replace(/\/$/, '');
const canonical = `${base}/blog/`;
const nextUrl = totalPages > 1 ? `${base}/blog/2/` : null;
---

<html lang="en">
  <head>
    <title>Blog | {siteConfig.companyName}</title>
    <link rel="canonical" href={canonical} />
    {nextUrl && <link rel="next" href={nextUrl} />}
  </head>
  <body>
    <PaginatedBlogLayout
      posts={firstPagePosts}
      currentPage={1}
      totalPages={totalPages}
      baseUrl="/blog"
      title="Blog"
      subtitle="Latest articles and news from the team"
    />
  </body>
</html>
