---
import PaginatedBlogLayout from '../../../components/blog/PaginatedBlogLayout.astro';
import { getBlogCollection, paginate } from '../../../utils/blog';
import { blogSetting, siteConfig } from '../../../data/config';
import type { APIContext } from 'astro';

export async function getStaticPaths() {
  const posts = await getBlogCollection();
  const perPage = blogSetting.postsPerPage ?? 6;
  const totalPages = Math.max(1, Math.ceil(posts.length / perPage));

  return Array.from({ length: totalPages }, (_, i) => {
    const page = i + 1;
    return {
      params: { page: String(page) },
      props: { page, totalPages, perPage }
    };
  });
}

const { page, totalPages, perPage } = Astro.props as { page: number; totalPages: number; perPage: number };
const posts = await getBlogCollection();
const { slice: paginatedPosts } = paginate(posts, page, perPage);

// Canonical and prev/next
const isFirst = page === 1;
const isLast = page === totalPages;
const base = siteConfig.siteUrl.replace(/\/$/, '');
const canonical = isFirst ? `${base}/blog/` : `${base}/blog/page/${page}/`;
const prevUrl = !isFirst ? (page === 2 ? `${base}/blog/` : `${base}/blog/page/${page-1}/`) : null;
const nextUrl = !isLast ? `${base}/blog/page/${page+1}/` : null;
---
<html lang="en">
  <head>
    <title>Blog â€” Page {page} | {siteConfig.companyName}</title>
    <link rel="canonical" href={canonical} />
    {prevUrl && <link rel="prev" href={prevUrl} />}
    {nextUrl && <link rel="next" href={nextUrl} />}
  </head>
  <body>
    <PaginatedBlogLayout
      posts={paginatedPosts}
      currentPage={page}
      totalPages={totalPages}
      baseUrl="/blog"
      title="Blog"
      subtitle="Latest articles and news from the team"
    />
  </body>
</html>